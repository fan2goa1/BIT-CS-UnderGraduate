/*
 * lcd_func.c
 *
 *  Created on: 2017??9??10??
 *      Author: admin
 */
#include "xgpio.h"
#include "gpio_initial.h"
#include"sleep.h"

/*
 * ???????? IC
 */
void send_command_to_ROM( uchar cmd )
{
	uchar i;

	for(i=0;i<8;i++ )
	{
		if(cmd&0x80) rom_mosi_H;
		else rom_mosi_L;
		cmd = cmd<<1;
		rom_sck_L;
		usleep(1);
		rom_sck_H;
		usleep(1);
	}
}

/*
 * ????????? IC ????????????????1 ??????
*/
uchar get_data_from_ROM( )
{
	uchar i,rom_receive;
	uchar ret_data=0;
	rom_sck_H;
	usleep(1);
	for(i=0;i<8;i++)
	{
		rom_sck_L;//?????????????rom?????????????
		usleep(1);
		ret_data=ret_data<<1;
		rom_receive=(uchar)rom_miso_Val;
		if(rom_receive==0x01)
			ret_data=ret_data+1;
		else
			ret_data=ret_data+0;
		rom_sck_H;
		usleep(1);
	}
	return(ret_data);
}

/*
 *  sent command to lcd
 */

void transfer_command(unsigned char cmd)
{
	char i;
	lcd_cs_L;
	lcd_rs_L;
	for (i=0;i<8;i++)
	{
		lcd_sck_L;
		if(cmd & 0x80) lcd_mosi_H;
		else lcd_mosi_L;
		lcd_sck_H;
		usleep(1);
		cmd<<=1;
	}
	lcd_cs_H;
}

/*
 *  sent data to lcd
 */

void transfer_data(unsigned char data)
{
	char i;
	lcd_cs_L;
	lcd_rs_H;
	for (i=0;i<8;i++)
	{
		lcd_sck_L;
		if(data & 0x80) lcd_mosi_H;
		else lcd_mosi_L;
		lcd_sck_H;
		usleep(1);
		data<<=1;
	}
	lcd_cs_H;
}

/*
 * ?????LCD???
 */
void initial_lcd()
{
	lcd_rstn_L;
	usleep(500);
	lcd_rstn_H;
	usleep(100);
	transfer_command(0x2c);
	usleep(200);
	transfer_command(0x2e);
	usleep(200);
	transfer_command(0x2f);
	usleep(10);
	transfer_command(0xae); //?????
	transfer_command(0x38); //??????
	transfer_command(0xb8); //85HZ
	transfer_command(0xc8); //????????
	transfer_command(0xa0); //????????
	transfer_command(0x44); //Set initial COM0 register
	transfer_command(0x00);
	transfer_command(0x40); //Set initial display line register
	transfer_command(0x00);
	transfer_command(0xab);
	transfer_command(0x67);
	transfer_command(0x26); //0x24 ?????????????¡Â?¦¶ 0x20??0x27
	transfer_command(0x81); //???????
	transfer_command(0x36); //36 ????????????????¡Â?¦¶ 0x00??0x3f
	transfer_command(0x54); //0x54 1/9 bias
	transfer_command(0xf3);
	transfer_command(0x04);
	transfer_command(0x93);
	// transfer_command(0x7b); //Extension Command Set3
	// transfer_command(0x11); //Gray mode
	// transfer_command(0x10); //Gray mode
	// transfer_command(0x00);
	transfer_command(0xaf); //?????
}

/*
 * ??¦Ë??LCD?????????????
 * ??????????¨°¦Ï??????????13?????4-6??
 */
void lcd_address(uchar page,uchar column)
{
	lcd_cs_L;
	column=column;
	page=page-1;
	transfer_command(0xb0+page);
	transfer_command(((column>>4)&0x0f)+0x10);
	transfer_command(column&0x0f);
}

/*
 * ????????
 */
void clear_screen()
{
	uchar i,j;
	for(j=0;j<16;j++)
	{
		lcd_address(j+1,0);
		for(i=0;i<128;i++)
		{
			transfer_data(0x00);
			transfer_data(0x00);
		}
	}
}

/*
 * ??????????
 */
void test_screen()
{
	uchar i,j;
	for(j=0;j<16;j++)
	{
		lcd_address(j+1,0);
		for(i=0;i<256;i++)
		{
			transfer_data(0xaa);
		}
	}
}

/*
 * ???????32*32????
 */
void display_32x32(uchar page,uchar column,uchar *dp)
{
	int i,j;
	for(j=0;j<4;j++)
	{
		lcd_address(page+j,column);
		for(i=0;i<32;i++)
		{
			transfer_data(*dp);
			transfer_data(*dp);
			dp++;
		}
	}
}

/*
 * ??????
 */
void display_graphic(uchar *dp)
{
	int i,j;
	for(j=0;j<16;j++)
	{
		lcd_address(j+1,0);
		for(i=0;i<128;i++)
		{
			transfer_data(*dp);
			transfer_data(*dp);
			dp++;
		}
	}
}

//????????????????§Õ????????????page,column)??????
void get_and_write_16x16(ulong fontaddr,uchar page,uchar column)
{
	uchar i,j,disp_data;
	rom_cs_L;
	send_command_to_ROM(0x03);
	send_command_to_ROM((fontaddr&0xff0000)>>16); //?????? 8 ¦Ë,?? 24 ¦Ë
	send_command_to_ROM((fontaddr&0xff00)>>8);  //??????? 8 ¦Ë,?? 24 ¦Ë
	send_command_to_ROM(fontaddr&0xff); //?????? 8 ¦Ë,?? 24 ¦Ë
	for(j=0;j<2;j++)
	{
		lcd_address(page+j,column);
		for(i=0; i<16; i++ )
		{
			disp_data=get_data_from_ROM();
			transfer_data(disp_data);  //§Õ????? LCD,?§Õ?? 1 ??????????§Ö??????? 1
			transfer_data(disp_data);  //§Õ????? LCD,?§Õ?? 1 ??????????§Ö??????? 1
		}
	}
	rom_cs_H;
}
//????????????????§Õ????????????page,column)??????
void get_and_write_8x16(ulong fontaddr,uchar page,uchar column)
{
	uchar i,j,disp_data;
	rom_cs_L;
	send_command_to_ROM(0x03);
	send_command_to_ROM((fontaddr&0xff0000)>>16); //?????? 8 ¦Ë,?? 24 ¦Ë
	send_command_to_ROM((fontaddr&0xff00)>>8);  //??????? 8 ¦Ë,?? 24 ¦Ë
	send_command_to_ROM(fontaddr&0xff); //?????? 8 ¦Ë,?? 24 ¦Ë
	for(j=0;j<2;j++)
	{
		lcd_address(page+j,column);
		for(i=0; i<8; i++ )
		{
			disp_data=get_data_from_ROM();
			transfer_data(disp_data);  //§Õ????? LCD,?§Õ?? 1 ??????????§Ö??????? 1
			transfer_data(disp_data);  //§Õ????? LCD,?§Õ?? 1 ??????????§Ö??????? 1
		}
	}
	rom_cs_H;
}
//****************************************************************

void display_GB2312_string(uchar page,uchar column, uchar *text)
{
	uchar i= 0;
	ulong fontaddr=0;
	while(((uchar)text[i]>0x00))
	{
		if(((text[i]>=0xb0) &&(text[i]<=0xf7))&&(text[i+1]>=0xa1))
		{
			//??????‰ÍGB2312??????????????? IC ?§Ö?????????????????
			//Address = ((MSB - 0xB0) * 94 + (LSB - 0xA1)+ 846)*32+ BaseAdd;BaseAdd=0
			//??????? 8 ¦Ë??????§Ô??????????????????????
			fontaddr = (text[i]- 0xb0)*94;
			fontaddr += (text[i+1]-0xa1)+846;
			fontaddr = (ulong)(fontaddr*32);
			get_and_write_16x16(fontaddr,page,column);  //????????????????§Õ????????????page,column)??????
			i+=2;
			column+=16;
		}
		else if(((text[i]>=0xa1) &&(text[i]<=0xa3))&&(text[i+1]>=0xa1))
		{
			//??????‰ÍGB2312??15x16 ??????????????? IC ?§Ö?????????????????
			//Address = ((MSB - 0xa1) * 94 + (LSB - 0xA1))*32+ BaseAdd;BaseAdd=0
			//??????? 8 ¦Ë??????§Ô??????????????????????
			fontaddr = (text[i]- 0xa1)*94;
			fontaddr += (text[i+1]-0xa1);
			fontaddr = (ulong)(fontaddr*32);
			get_and_write_16x16(fontaddr,page,column);  //????????????????§Õ????????????page,column)??????
			i+=2;
			column+=16;
		}
		else if((text[i]>=0x20) &&(text[i]<=0x7e))
		{
			fontaddr = (text[i]- 0x20);
			fontaddr = (ulong)(fontaddr*16);
			fontaddr = (ulong)(fontaddr+0x3cf80);
			get_and_write_8x16(fontaddr,page,column); //????????????????§Õ????????????page,column)??????
			i+=1;
			column+=8;
		}
		else
			i++;
	}
}
